<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Daggerheart Character Tracker</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #1a1225;
  --bg-light: #241a33;
  --card: #2a1f3d;
  --card-hover: #332649;
  --primary: #c9a84c;
  --primary-dim: #a68a3a;
  --accent: #7b5ea7;
  --accent-light: #9b7ec7;
  --text: #e8e0f0;
  --text-dim: #a89bb8;
  --text-dark: #6b5f7a;
  --border: #3d2f55;
  --danger: #c0392b;
  --danger-light: #e74c3c;
  --success: #27ae60;
  --hp-fill: #c0392b;
  --stress-fill: #7b5ea7;
  --armor-fill: #c9a84c;
  --hope-fill: #f0c040;
  --fear-fill: #5a3e7a;
  --radius: 10px;
  --radius-sm: 6px;
  --slot-size: 32px;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.5;
  min-height: 100vh;
}

/* Header */
header {
  background: linear-gradient(135deg, #1f1535 0%, #2d1a4a 50%, #1f1535 100%);
  border-bottom: 2px solid var(--primary);
  padding: 1rem 1.5rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 0.75rem;
}
header h1 {
  font-size: 1.4rem;
  font-weight: 700;
  color: var(--primary);
  letter-spacing: 2px;
  text-transform: uppercase;
}
.char-controls {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  flex-wrap: wrap;
}
.char-controls select {
  background: var(--card);
  color: var(--text);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 0.4rem 0.75rem;
  font-size: 0.9rem;
  min-width: 180px;
}
.btn {
  display: inline-flex;
  align-items: center;
  gap: 0.3rem;
  padding: 0.4rem 0.75rem;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  background: var(--card);
  color: var(--text);
  font-size: 0.85rem;
  cursor: pointer;
  transition: background 0.15s, border-color 0.15s;
}
.btn:hover { background: var(--card-hover); border-color: var(--primary-dim); }
.btn-primary { background: var(--accent); border-color: var(--accent); color: #fff; }
.btn-primary:hover { background: var(--accent-light); }
.btn-danger { border-color: var(--danger); color: var(--danger-light); }
.btn-danger:hover { background: rgba(192,57,43,0.15); }
.btn-sm { padding: 0.25rem 0.5rem; font-size: 0.8rem; }

/* Layout */
.sheet {
  max-width: 1200px;
  margin: 1rem auto;
  padding: 0 1rem 2rem;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
}
.full-width { grid-column: 1 / -1; }

/* Cards / Sections */
.section {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
}
.section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0.6rem 1rem;
  background: var(--bg-light);
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  user-select: none;
}
.section-header h2 {
  font-size: 0.9rem;
  font-weight: 600;
  color: var(--primary);
  text-transform: uppercase;
  letter-spacing: 1px;
}
.section-header .chevron {
  color: var(--text-dim);
  transition: transform 0.2s;
  font-size: 0.8rem;
}
.section.collapsed .section-header .chevron { transform: rotate(-90deg); }
.section.collapsed .section-body { display: none; }
.section-body { padding: 1rem; }

/* Form inputs */
input[type="text"], input[type="number"], textarea, select {
  background: var(--bg);
  color: var(--text);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 0.4rem 0.6rem;
  font-size: 0.9rem;
  font-family: inherit;
  width: 100%;
  transition: border-color 0.15s;
}
input:focus, textarea:focus, select:focus {
  outline: none;
  border-color: var(--accent);
}
input[type="number"] { width: 70px; text-align: center; }
textarea { resize: vertical; min-height: 80px; }
label {
  display: block;
  font-size: 0.75rem;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 0.2rem;
}

/* Identity grid */
.identity-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 0.75rem;
}
.identity-grid .field-group { display: flex; flex-direction: column; }

/* Traits */
.traits-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 0.75rem;
}
.trait-block {
  display: flex;
  flex-direction: column;
  align-items: center;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 0.6rem;
}
.trait-block .trait-name {
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-dim);
  margin-bottom: 0.3rem;
}
.trait-block .trait-value {
  font-size: 1.6rem;
  font-weight: 700;
  color: var(--primary);
  min-width: 2.5rem;
  text-align: center;
}
.trait-controls {
  display: flex;
  gap: 0.4rem;
  margin-top: 0.3rem;
}
.trait-controls button {
  width: 26px;
  height: 26px;
  border-radius: 50%;
  border: 1px solid var(--border);
  background: var(--card);
  color: var(--text);
  font-size: 1rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  line-height: 1;
}
.trait-controls button:hover { background: var(--card-hover); border-color: var(--primary-dim); }

/* Combat stats */
.combat-row {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-bottom: 0.75rem;
  flex-wrap: wrap;
}
.combat-row:last-child { margin-bottom: 0; }
.combat-label {
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-dim);
  min-width: 100px;
}
.combat-value {
  font-size: 1.3rem;
  font-weight: 700;
  color: var(--primary);
  min-width: 40px;
  text-align: center;
}

/* Slot trackers */
.slots {
  display: flex;
  gap: 4px;
  flex-wrap: wrap;
  align-items: center;
}
.slot {
  width: var(--slot-size);
  height: var(--slot-size);
  border-radius: 4px;
  border: 2px solid var(--border);
  background: var(--bg);
  cursor: pointer;
  transition: background 0.15s, border-color 0.15s;
}
.slot:hover { border-color: var(--text-dim); }
.slot.filled-hp { background: var(--hp-fill); border-color: var(--hp-fill); }
.slot.filled-stress { background: var(--stress-fill); border-color: var(--stress-fill); }
.slot.filled-armor { background: var(--armor-fill); border-color: var(--armor-fill); }
.slot-config {
  display: flex;
  align-items: center;
  gap: 0.3rem;
  margin-left: 0.5rem;
}
.slot-config label { margin-bottom: 0; font-size: 0.7rem; }
.slot-config input[type="number"] { width: 50px; padding: 0.2rem 0.4rem; font-size: 0.8rem; }

/* Thresholds */
.thresholds-row {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
}
.threshold-item {
  display: flex;
  flex-direction: column;
  align-items: center;
}
.threshold-item label { font-size: 0.7rem; }
.threshold-item input[type="number"] { width: 60px; }

/* Hope / Fear */
.hope-fear-row {
  display: flex;
  gap: 2rem;
  flex-wrap: wrap;
}
.counter-group {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}
.counter-group .counter-label {
  font-size: 0.8rem;
  text-transform: uppercase;
  letter-spacing: 1px;
  font-weight: 600;
  min-width: 50px;
}
.counter-group .counter-label.hope { color: var(--hope-fill); }
.counter-group .counter-label.fear { color: var(--accent); }
.counter-value {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--primary);
  min-width: 2rem;
  text-align: center;
}
.counter-btn {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  border: 1px solid var(--border);
  background: var(--card);
  color: var(--text);
  font-size: 1.1rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}
.counter-btn:hover { background: var(--card-hover); border-color: var(--primary-dim); }

/* List items (weapons, experiences, domain cards, inventory) */
.list-item {
  display: flex;
  gap: 0.5rem;
  align-items: flex-start;
  padding: 0.5rem;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  margin-bottom: 0.5rem;
}
.list-item:last-child { margin-bottom: 0; }
.list-item .list-fields { flex: 1; display: flex; flex-direction: column; gap: 0.3rem; }
.list-item .list-fields .row { display: flex; gap: 0.4rem; align-items: center; }
.list-item .list-fields input { font-size: 0.85rem; }
.list-item .list-fields .small-input { width: 60px; flex-shrink: 0; }
.list-item .remove-btn {
  background: none;
  border: none;
  color: var(--text-dark);
  cursor: pointer;
  font-size: 1.1rem;
  padding: 0.2rem;
  line-height: 1;
  flex-shrink: 0;
}
.list-item .remove-btn:hover { color: var(--danger-light); }
.add-row {
  margin-top: 0.5rem;
}

/* Domain card groups */
.domain-group { margin-bottom: 1rem; }
.domain-group:last-child { margin-bottom: 0; }
.domain-group-title {
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--accent-light);
  margin-bottom: 0.5rem;
  padding-bottom: 0.25rem;
  border-bottom: 1px solid var(--border);
}
.move-btn {
  background: none;
  border: none;
  color: var(--accent-light);
  cursor: pointer;
  font-size: 0.75rem;
  padding: 0.15rem 0.3rem;
  text-decoration: underline;
}
.move-btn:hover { color: var(--primary); }

/* Notes */
.notes-area { width: 100%; min-height: 150px; }

/* Card Browser */
.domain-tabs {
  display: flex; gap: 0.3rem; flex-wrap: wrap; margin-bottom: 0.75rem; padding-top: 0.5rem;
}
.domain-tab {
  padding: 0.25rem 0.6rem; border-radius: var(--radius-sm); border: 1px solid var(--border);
  background: var(--bg); color: var(--text-dim); font-size: 0.8rem; cursor: pointer;
}
.domain-tab:hover { border-color: var(--primary-dim); color: var(--text); }
.domain-tab.active { background: var(--accent); border-color: var(--accent); color: #fff; }
.browser-card {
  display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.5rem;
  background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius-sm);
  margin-bottom: 0.3rem; font-size: 0.85rem;
}
.browser-card .card-info { flex: 1; }
.browser-card .card-info .card-name { color: var(--text); font-weight: 500; }
.browser-card .card-info .card-meta { color: var(--text-dark); font-size: 0.75rem; }
.browser-card.already-added { opacity: 0.45; }
.browser-card.already-added .btn { pointer-events: none; }

/* Responsive */
@media (max-width: 768px) {
  .sheet { grid-template-columns: 1fr; }
  .traits-grid { grid-template-columns: repeat(2, 1fr); }
  .identity-grid { grid-template-columns: 1fr 1fr; }
  header { flex-direction: column; text-align: center; }
}
@media (max-width: 480px) {
  .traits-grid { grid-template-columns: 1fr 1fr; }
  .identity-grid { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<header>
  <h1>Daggerheart</h1>
  <div class="char-controls">
    <select id="charSelect"></select>
    <button class="btn btn-primary" onclick="newCharacter()">+ New</button>
    <button class="btn btn-danger" onclick="deleteCharacter()">Delete</button>
  </div>
</header>

<div class="sheet" id="sheet">

  <!-- Identity -->
  <div class="section full-width" data-section="identity">
    <div class="section-header" onclick="toggleSection(this)">
      <h2>Character Identity</h2>
      <span class="chevron">&#9660;</span>
    </div>
    <div class="section-body">
      <div class="identity-grid">
        <div class="field-group">
          <label>Name</label>
          <input type="text" data-field="name" placeholder="Character name">
        </div>
        <div class="field-group">
          <label>Pronouns</label>
          <input type="text" data-field="pronouns" placeholder="they/them">
        </div>
        <div class="field-group">
          <label>Level</label>
          <input type="number" data-field="level" min="1" max="10" value="1" style="width:100%">
        </div>
        <div class="field-group">
          <label>Tier</label>
          <input type="text" id="tierDisplay" readonly style="color:var(--primary);font-weight:600">
        </div>
        <div class="field-group">
          <label>Proficiency</label>
          <input type="text" id="profDisplay" readonly style="color:var(--primary);font-weight:600">
        </div>
        <div class="field-group">
          <label>Ancestry</label>
          <select data-field="ancestry" id="ancestrySelect"><option value="">-- Select Ancestry --</option></select>
        </div>
        <div class="field-group">
          <label>Community</label>
          <select data-field="community" id="communitySelect"><option value="">-- Select Community --</option></select>
        </div>
        <div class="field-group">
          <label>Class</label>
          <select data-field="class" id="classSelect"><option value="">-- Select Class --</option></select>
        </div>
        <div class="field-group">
          <label>Subclass</label>
          <select data-field="subclass" id="subclassSelect"><option value="">-- Select Subclass --</option></select>
        </div>
      </div>
    </div>
  </div>

  <!-- Traits -->
  <div class="section" data-section="traits">
    <div class="section-header" onclick="toggleSection(this)">
      <h2>Traits</h2>
      <span class="chevron">&#9660;</span>
    </div>
    <div class="section-body">
      <div class="traits-grid" id="traitsGrid"></div>
    </div>
  </div>

  <!-- Combat Stats -->
  <div class="section" data-section="combat">
    <div class="section-header" onclick="toggleSection(this)">
      <h2>Combat Stats</h2>
      <span class="chevron">&#9660;</span>
    </div>
    <div class="section-body">
      <div class="combat-row">
        <span class="combat-label">Evasion</span>
        <input type="number" data-field="evasion" value="10" style="width:70px" readonly>
      </div>
      <div class="combat-row">
        <span class="combat-label">Hit Points</span>
        <div class="slots" id="hpSlots"></div>
        <div class="slot-config">
          <label>Max</label>
          <input type="number" id="hpMaxInput" min="1" max="20" value="6">
        </div>
      </div>
      <div class="combat-row">
        <span class="combat-label">Stress</span>
        <div class="slots" id="stressSlots"></div>
        <div class="slot-config">
          <label>Max</label>
          <input type="number" id="stressMaxInput" min="1" max="20" value="6">
        </div>
      </div>
      <div class="combat-row">
        <span class="combat-label">Armor Score</span>
        <input type="number" id="combatArmorScore" value="0" style="width:70px" readonly>
      </div>
      <div class="combat-row">
        <span class="combat-label">Armor Slots</span>
        <div class="slots" id="armorSlots"></div>
        <div class="slot-config">
          <label>Max</label>
          <input type="number" id="armorSlotsInput" min="0" max="12" value="0" readonly>
        </div>
      </div>
      <div class="combat-row">
        <span class="combat-label">Damage Thresholds</span>
        <div class="thresholds-row">
          <div class="threshold-item">
            <label>Major</label>
            <input type="number" id="combatThreshMajor" value="0" readonly>
          </div>
          <div class="threshold-item">
            <label>Severe</label>
            <input type="number" id="combatThreshSevere" value="0" readonly>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Hope & Fear -->
  <div class="section" data-section="hopefear">
    <div class="section-header" onclick="toggleSection(this)">
      <h2>Hope & Fear</h2>
      <span class="chevron">&#9660;</span>
    </div>
    <div class="section-body">
      <div class="hope-fear-row">
        <div class="counter-group">
          <span class="counter-label hope">Hope</span>
          <button class="counter-btn" onclick="adjustCounter('hope',-1)">-</button>
          <span class="counter-value" id="hopeValue">0</span>
          <button class="counter-btn" onclick="adjustCounter('hope',1)">+</button>
        </div>
        <div class="counter-group">
          <span class="counter-label fear">Fear</span>
          <button class="counter-btn" onclick="adjustCounter('fear',-1)">-</button>
          <span class="counter-value" id="fearValue">0</span>
          <button class="counter-btn" onclick="adjustCounter('fear',1)">+</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Weapons & Equipment -->
  <div class="section" data-section="weapons">
    <div class="section-header" onclick="toggleSection(this)">
      <h2>Weapons & Equipment</h2>
      <span class="chevron">&#9660;</span>
    </div>
    <div class="section-body">
      <div id="weaponsList"></div>
      <div class="add-row">
        <button class="btn btn-sm" onclick="addWeapon()">+ Add Weapon / Item</button>
      </div>
    </div>
  </div>

  <!-- Active Armor -->
  <div class="section" data-section="activearmor">
    <div class="section-header" onclick="toggleSection(this)">
      <h2>Active Armor</h2>
      <span class="chevron">&#9660;</span>
    </div>
    <div class="section-body">
      <div style="display:flex;gap:0.5rem;flex-wrap:wrap;margin-bottom:0.75rem">
        <div class="field-group" style="flex:3;min-width:180px">
          <label>Armor</label>
          <select id="armorSelect"><option value="">-- Select Armor --</option></select>
        </div>
        <div class="field-group" style="flex:1;min-width:60px">
          <label>Score</label>
          <input type="number" id="armorScoreDisplay" readonly style="color:var(--primary);font-weight:600">
        </div>
        <div class="field-group" style="flex:1;min-width:60px">
          <label>Slots</label>
          <input type="number" id="armorSlotsDisplay" readonly style="color:var(--primary);font-weight:600">
        </div>
      </div>
      <div style="display:flex;gap:0.75rem;flex-wrap:wrap;margin-bottom:0.5rem">
        <div class="field-group">
          <label>Major Threshold</label>
          <input type="number" id="armorMajorDisplay" readonly style="width:70px;color:var(--primary);font-weight:600">
        </div>
        <div class="field-group">
          <label>Severe Threshold</label>
          <input type="number" id="armorSevereDisplay" readonly style="width:70px;color:var(--primary);font-weight:600">
        </div>
      </div>
      <div id="armorFeatureDisplay" style="color:var(--text-dim);font-size:0.8rem;font-style:italic"></div>
    </div>
  </div>

  <!-- Experiences -->
  <div class="section" data-section="experiences">
    <div class="section-header" onclick="toggleSection(this)">
      <h2>Experiences</h2>
      <span class="chevron">&#9660;</span>
    </div>
    <div class="section-body">
      <div id="experiencesList"></div>
      <div class="add-row">
        <button class="btn btn-sm" onclick="addExperience()">+ Add Experience</button>
      </div>
    </div>
  </div>

  <!-- Domain Cards -->
  <div class="section" data-section="domain">
    <div class="section-header" onclick="toggleSection(this)">
      <h2>Domain Cards</h2>
      <span class="chevron">&#9660;</span>
    </div>
    <div class="section-body">
      <div class="domain-group" id="cardBrowserGroup" style="display:none">
        <div class="domain-group-title" style="cursor:pointer;display:flex;justify-content:space-between;align-items:center" onclick="toggleCardBrowser()">
          <span>Card Browser</span>
          <span class="chevron" id="browserChevron">&#9660;</span>
        </div>
        <div id="cardBrowserBody">
          <div class="domain-tabs" id="domainTabs"></div>
          <div id="browserCardList"></div>
        </div>
      </div>
      <div class="domain-group">
        <div class="domain-group-title">Loadout</div>
        <div id="loadoutList"></div>
        <div class="add-row">
          <button class="btn btn-sm" onclick="addDomainCard('loadout')">+ Add to Loadout</button>
        </div>
      </div>
      <div class="domain-group">
        <div class="domain-group-title">Vault</div>
        <div id="vaultList"></div>
        <div class="add-row">
          <button class="btn btn-sm" onclick="addDomainCard('vault')">+ Add to Vault</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Notes -->
  <div class="section full-width" data-section="notes">
    <div class="section-header" onclick="toggleSection(this)">
      <h2>Notes</h2>
      <span class="chevron">&#9660;</span>
    </div>
    <div class="section-body">
      <textarea class="notes-area" data-field="notes" placeholder="Backstory, motivations, session notes..."></textarea>
    </div>
  </div>

</div>

<script>
const STORAGE_KEY = 'daggerheart_characters';
const TRAITS = ['agility','strength','finesse','instinct','presence','knowledge'];

const DAGGERHEART_DATA = {
  ancestries: ['Clank','Drakona','Dwarf','Elf','Faerie','Faun','Firbolg','Fungril','Galapa','Giant','Goblin','Halfling','Human','Infernis','Katari','Orc','Ribbet','Simiah'],
  // Ancestry modifiers applied at creation: hp/stress/evasion deltas
  ancestryMods: {
    Giant:  { hp: 1 },
    Human:  { stress: 1 },
    Simiah: { evasion: 1 }
  },
  communities: ['Highborne','Loreborne','Orderborne','Ridgeborne','Seaborne','Slyborne','Underborne','Wanderborne','Wildborne'],
  classes: {
    Bard:       { domains: ['Grace','Codex'], subclasses: ['Troubadour','Wordsmith'], evasion: 10, hp: 5 },
    Druid:      { domains: ['Sage','Arcana'], subclasses: ['Warden of Renewal','Warden of the Elements'], evasion: 10, hp: 6 },
    Guardian:   { domains: ['Valor','Blade'], subclasses: ['Stalwart','Vengeant'], evasion: 9, hp: 7 },
    Ranger:     { domains: ['Sage','Bone'], subclasses: ['Wayfinder','Beastbound'], evasion: 12, hp: 6 },
    Rogue:      { domains: ['Midnight','Grace'], subclasses: ['Syndicate','Nightwalker'], evasion: 12, hp: 6 },
    Seraph:     { domains: ['Splendor','Valor'], subclasses: ['Winged Sentinel','Divine Wielder'], evasion: 9, hp: 7 },
    Sorcerer:   { domains: ['Arcana','Midnight'], subclasses: ['Elemental Origin','Primal Origin'], evasion: 10, hp: 6 },
    Warrior:    { domains: ['Blade','Bone'], subclasses: ['Call of the Brave','Call of the Slayer'], evasion: 11, hp: 6 },
    Wizard:     { domains: ['Codex','Splendor'], subclasses: ['School of Knowledge','School of Stars'], evasion: 11, hp: 5 }
  },
  domainCards: {
    Arcana: [
      {name:'Arcane Volley',level:1,type:'Ability'},{name:'Channel Elements',level:1,type:'Ability'},
      {name:'Elemental Burst',level:1,type:'Ability'},{name:'Magic Torrent',level:1,type:'Ability'},
      {name:'Arcane Armor',level:2,type:'Ability'},{name:'Counterspell',level:2,type:'Ability'},
      {name:'Illusory Disguise',level:2,type:'Ability'},{name:'Overcharge',level:2,type:'Ability'},
      {name:'Arcane Sight',level:3,type:'Ability'},{name:'Displacement',level:3,type:'Ability'},
      {name:'Elemental Wall',level:3,type:'Ability'},{name:'Thunderstrike',level:3,type:'Ability'},
      {name:'Blink',level:4,type:'Ability'},{name:'Chain Lightning',level:4,type:'Ability'},
      {name:'Shatter',level:4,type:'Ability'},{name:'Arcane Storm',level:5,type:'Ability'},
      {name:'Elemental Form',level:5,type:'Ability'},{name:'Meteor',level:6,type:'Ability'},
      {name:'Time Stop',level:7,type:'Ability'},{name:'Arcanist',level:1,type:'Passive'},
      {name:'Mana Well',level:3,type:'Passive'}
    ],
    Blade: [
      {name:'Aggressive Strike',level:1,type:'Ability'},{name:'Deflect',level:1,type:'Ability'},
      {name:'Power Strike',level:1,type:'Ability'},{name:'Whirlwind',level:1,type:'Ability'},
      {name:'Battle Cry',level:2,type:'Ability'},{name:'Cleave',level:2,type:'Ability'},
      {name:'Fortify',level:2,type:'Ability'},{name:'Shield Bash',level:2,type:'Ability'},
      {name:'Blade Storm',level:3,type:'Ability'},{name:'Challenge',level:3,type:'Ability'},
      {name:'Iron Will',level:3,type:'Ability'},{name:'Riposte',level:3,type:'Ability'},
      {name:'Devastating Blow',level:4,type:'Ability'},{name:'Hold the Line',level:4,type:'Ability'},
      {name:'Unstoppable',level:4,type:'Ability'},{name:'Executioner',level:5,type:'Ability'},
      {name:'Whirlwind of Steel',level:5,type:'Ability'},{name:'Invincible',level:6,type:'Ability'},
      {name:'Avatar of War',level:7,type:'Ability'},{name:'Blade Mastery',level:1,type:'Passive'},
      {name:'Warrior Born',level:3,type:'Passive'}
    ],
    Bone: [
      {name:'Animal Companion',level:1,type:'Ability'},{name:'Bone Dart',level:1,type:'Ability'},
      {name:'Hunter\'s Mark',level:1,type:'Ability'},{name:'Snare',level:1,type:'Ability'},
      {name:'Beastspeak',level:2,type:'Ability'},{name:'Bonecraft Armor',level:2,type:'Ability'},
      {name:'Pack Tactics',level:2,type:'Ability'},{name:'Vine Snare',level:2,type:'Ability'},
      {name:'Feral Strike',level:3,type:'Ability'},{name:'Poison Cloud',level:3,type:'Ability'},
      {name:'Summon Swarm',level:3,type:'Ability'},{name:'Wild Shape',level:3,type:'Ability'},
      {name:'Alpha Predator',level:4,type:'Ability'},{name:'Bone Prison',level:4,type:'Ability'},
      {name:'Nature\'s Wrath',level:4,type:'Ability'},{name:'Dire Form',level:5,type:'Ability'},
      {name:'Plague',level:5,type:'Ability'},{name:'Apex Predator',level:6,type:'Ability'},
      {name:'Primeval Storm',level:7,type:'Ability'},{name:'Wild Heart',level:1,type:'Passive'},
      {name:'Pack Leader',level:3,type:'Passive'}
    ],
    Codex: [
      {name:'Arcane Record',level:1,type:'Ability'},{name:'Guided Strike',level:1,type:'Ability'},
      {name:'Ink Bolt',level:1,type:'Ability'},{name:'Translate',level:1,type:'Ability'},
      {name:'Comprehend Languages',level:2,type:'Ability'},{name:'Glyph of Warding',level:2,type:'Ability'},
      {name:'Identify',level:2,type:'Ability'},{name:'Runic Shield',level:2,type:'Ability'},
      {name:'Dispel Magic',level:3,type:'Ability'},{name:'Lore Master',level:3,type:'Ability'},
      {name:'Scrying',level:3,type:'Ability'},{name:'Sigil of Binding',level:3,type:'Ability'},
      {name:'Mass Translate',level:4,type:'Ability'},{name:'Power Word',level:4,type:'Ability'},
      {name:'True Name',level:4,type:'Ability'},{name:'Omniglot',level:5,type:'Ability'},
      {name:'Seal',level:5,type:'Ability'},{name:'Codex of Ages',level:6,type:'Ability'},
      {name:'Rewrite Reality',level:7,type:'Ability'},{name:'Scholar',level:1,type:'Passive'},
      {name:'Living Library',level:3,type:'Passive'}
    ],
    Grace: [
      {name:'Charm',level:1,type:'Ability'},{name:'Feather Step',level:1,type:'Ability'},
      {name:'Inspire',level:1,type:'Ability'},{name:'Tumble',level:1,type:'Ability'},
      {name:'Dazzle',level:2,type:'Ability'},{name:'Graceful Exit',level:2,type:'Ability'},
      {name:'Soothing Word',level:2,type:'Ability'},{name:'Vanish',level:2,type:'Ability'},
      {name:'Dance of Blades',level:3,type:'Ability'},{name:'Enthrall',level:3,type:'Ability'},
      {name:'Group Invisibility',level:3,type:'Ability'},{name:'Rally',level:3,type:'Ability'},
      {name:'Dominate',level:4,type:'Ability'},{name:'Miracle Step',level:4,type:'Ability'},
      {name:'Wind Walk',level:4,type:'Ability'},{name:'Captivate',level:5,type:'Ability'},
      {name:'Mass Charm',level:5,type:'Ability'},{name:'Time Skip',level:6,type:'Ability'},
      {name:'Fate Weaver',level:7,type:'Ability'},{name:'Light Footed',level:1,type:'Passive'},
      {name:'Effortless',level:3,type:'Passive'}
    ],
    Midnight: [
      {name:'Backstab',level:1,type:'Ability'},{name:'Cloak of Shadows',level:1,type:'Ability'},
      {name:'Shadow Bolt',level:1,type:'Ability'},{name:'Smoke Bomb',level:1,type:'Ability'},
      {name:'Dark Vision',level:2,type:'Ability'},{name:'Poison Blade',level:2,type:'Ability'},
      {name:'Shadow Step',level:2,type:'Ability'},{name:'Silence',level:2,type:'Ability'},
      {name:'Assassinate',level:3,type:'Ability'},{name:'Creeping Darkness',level:3,type:'Ability'},
      {name:'Shadow Clone',level:3,type:'Ability'},{name:'Umbral Snare',level:3,type:'Ability'},
      {name:'Death Mark',level:4,type:'Ability'},{name:'Shadow Gate',level:4,type:'Ability'},
      {name:'Void Strike',level:4,type:'Ability'},{name:'Eclipse',level:5,type:'Ability'},
      {name:'Shadow Army',level:5,type:'Ability'},{name:'Nightfall',level:6,type:'Ability'},
      {name:'Eternal Shadow',level:7,type:'Ability'},{name:'Shadow Born',level:1,type:'Passive'},
      {name:'One with Night',level:3,type:'Passive'}
    ],
    Sage: [
      {name:'Healing Touch',level:1,type:'Ability'},{name:'Nature\'s Grasp',level:1,type:'Ability'},
      {name:'Purify',level:1,type:'Ability'},{name:'Speak with Nature',level:1,type:'Ability'},
      {name:'Barkskin',level:2,type:'Ability'},{name:'Entangle',level:2,type:'Ability'},
      {name:'Restoration',level:2,type:'Ability'},{name:'Wild Growth',level:2,type:'Ability'},
      {name:'Greater Healing',level:3,type:'Ability'},{name:'Lightning Strike',level:3,type:'Ability'},
      {name:'Stone Wall',level:3,type:'Ability'},{name:'Wind Gust',level:3,type:'Ability'},
      {name:'Mass Heal',level:4,type:'Ability'},{name:'Earthquake',level:4,type:'Ability'},
      {name:'Tidal Wave',level:4,type:'Ability'},{name:'Regeneration',level:5,type:'Ability'},
      {name:'Storm Call',level:5,type:'Ability'},{name:'Tree of Life',level:6,type:'Ability'},
      {name:'Nature\'s Avatar',level:7,type:'Ability'},{name:'Naturalist',level:1,type:'Passive'},
      {name:'Deep Roots',level:3,type:'Passive'}
    ],
    Splendor: [
      {name:'Blessed Strike',level:1,type:'Ability'},{name:'Divine Light',level:1,type:'Ability'},
      {name:'Guiding Bolt',level:1,type:'Ability'},{name:'Shield of Faith',level:1,type:'Ability'},
      {name:'Celestial Armor',level:2,type:'Ability'},{name:'Consecrate',level:2,type:'Ability'},
      {name:'Radiant Burst',level:2,type:'Ability'},{name:'Smite',level:2,type:'Ability'},
      {name:'Aura of Protection',level:3,type:'Ability'},{name:'Beacon of Hope',level:3,type:'Ability'},
      {name:'Blinding Light',level:3,type:'Ability'},{name:'Wings of Light',level:3,type:'Ability'},
      {name:'Divine Judgment',level:4,type:'Ability'},{name:'Holy Fire',level:4,type:'Ability'},
      {name:'Resurrection',level:4,type:'Ability'},{name:'Celestial Form',level:5,type:'Ability'},
      {name:'Sunburst',level:5,type:'Ability'},{name:'Divine Intervention',level:6,type:'Ability'},
      {name:'Apotheosis',level:7,type:'Ability'},{name:'Radiant Soul',level:1,type:'Passive'},
      {name:'Divine Favor',level:3,type:'Passive'}
    ],
    Valor: [
      {name:'Bolster',level:1,type:'Ability'},{name:'Heroic Strike',level:1,type:'Ability'},
      {name:'Protect',level:1,type:'Ability'},{name:'Taunt',level:1,type:'Ability'},
      {name:'Adrenaline Rush',level:2,type:'Ability'},{name:'Bulwark',level:2,type:'Ability'},
      {name:'Inspiring Presence',level:2,type:'Ability'},{name:'Shield Wall',level:2,type:'Ability'},
      {name:'Defender\'s Stand',level:3,type:'Ability'},{name:'Heroic Leap',level:3,type:'Ability'},
      {name:'Rally the Fallen',level:3,type:'Ability'},{name:'Unbreakable',level:3,type:'Ability'},
      {name:'Champion\'s Challenge',level:4,type:'Ability'},{name:'Last Stand',level:4,type:'Ability'},
      {name:'Valor\'s Edge',level:4,type:'Ability'},{name:'Indomitable',level:5,type:'Ability'},
      {name:'War Cry',level:5,type:'Ability'},{name:'Legendary Defender',level:6,type:'Ability'},
      {name:'Paragon',level:7,type:'Ability'},{name:'Courageous Heart',level:1,type:'Passive'},
      {name:'Unshakeable',level:3,type:'Passive'}
    ]
  },
  armor: [
    // Tier 1
    {name:'Unarmored',tier:0,score:0,major:0,severe:0,feature:''},
    {name:'Gambeson',tier:1,score:3,major:5,severe:11,feature:'Flexible: +1 Evasion',evasionMod:1},
    {name:'Leather',tier:1,score:3,major:6,severe:13,feature:''},
    {name:'Chainmail',tier:1,score:4,major:7,severe:15,feature:'Heavy: -1 Evasion',evasionMod:-1},
    {name:'Full Plate',tier:1,score:4,major:8,severe:17,feature:'Very Heavy: -2 Evasion, -1 Agility',evasionMod:-2},
    // Tier 2
    {name:'Improved Gambeson',tier:2,score:4,major:7,severe:16,feature:'Flexible: +1 Evasion',evasionMod:1},
    {name:'Improved Leather',tier:2,score:4,major:9,severe:20,feature:''},
    {name:'Improved Chainmail',tier:2,score:5,major:11,severe:24,feature:'Heavy: -1 Evasion',evasionMod:-1},
    {name:'Improved Full Plate',tier:2,score:5,major:13,severe:28,feature:'Very Heavy: -2 Evasion, -1 Agility',evasionMod:-2},
    {name:'Elundrian Chain',tier:2,score:4,major:9,severe:21,feature:'Warded: reduce incoming magic damage'},
    {name:'Harrowbone',tier:2,score:4,major:9,severe:21,feature:'Resilient: d6 protection'},
    {name:'Irontree Breastplate',tier:2,score:4,major:9,severe:20,feature:'Reinforced: threshold bonus'},
    {name:'Runetan Floating',tier:2,score:4,major:9,severe:20,feature:'Shifting: disadvantage feature'},
    {name:'Tyris Soft',tier:2,score:5,major:8,severe:18,feature:'+2 bonus to stealth'},
    {name:'Rosewild',tier:2,score:5,major:11,severe:23,feature:'Hope-to-Armor conversion'},
    // Tier 3
    {name:'Advanced Gambeson',tier:3,score:5,major:9,severe:23,feature:'Flexible: +1 Evasion',evasionMod:1},
    {name:'Advanced Leather',tier:3,score:5,major:11,severe:27,feature:''},
    {name:'Advanced Chainmail',tier:3,score:6,major:13,severe:31,feature:'Heavy: -1 Evasion',evasionMod:-1},
    {name:'Advanced Full Plate',tier:3,score:6,major:15,severe:35,feature:'Very Heavy: -2 Evasion, -1 Agility',evasionMod:-2},
    {name:'Bellamie Fine',tier:3,score:5,major:11,severe:27,feature:'+1 to Presence'},
    {name:'Dragonscale',tier:3,score:5,major:11,severe:27,feature:'Stress conversion'},
    {name:'Spiked Plate',tier:3,score:5,major:10,severe:25,feature:'Add d4 to melee damage'},
    {name:'Bladefare',tier:3,score:6,major:16,severe:39,feature:'Physical damage only'},
    {name:"Monett's Cloak",tier:3,score:6,major:16,severe:39,feature:'Magic damage only'},
    {name:'Runes of Fortification',tier:3,score:6,major:17,severe:43,feature:'Must mark Stress'},
    // Tier 4
    {name:'Legendary Gambeson',tier:4,score:6,major:11,severe:32,feature:'Flexible: +1 Evasion',evasionMod:1},
    {name:'Legendary Leather',tier:4,score:6,major:13,severe:36,feature:''},
    {name:'Legendary Chainmail',tier:4,score:7,major:15,severe:40,feature:'Heavy: -1 Evasion',evasionMod:-1},
    {name:'Legendary Full Plate',tier:4,score:7,major:17,severe:44,feature:'Very Heavy: -2 Evasion, -1 Agility',evasionMod:-2},
    {name:'Dunamis Silkchain',tier:4,score:7,major:13,severe:36,feature:'d4 Evasion bonus'},
    {name:'Channeling',tier:4,score:5,major:13,severe:36,feature:'+1 to Spellcast'},
    {name:'Emberwoven',tier:4,score:6,major:13,severe:36,feature:'Enemy Stress marking'},
    {name:'Full Fortified',tier:4,score:4,major:15,severe:40,feature:'Doubled severity reduction'},
    {name:'Veritas Opal',tier:4,score:6,major:13,severe:36,feature:'Lie detection'},
    {name:'Savior Chainmail',tier:4,score:8,major:18,severe:48,feature:'-1 to traits and Evasion',evasionMod:-1}
  ]
};

function uuid() {
  return crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(36) + Math.random().toString(36).slice(2);
}

function defaultChar() {
  return {
    id: uuid(),
    name: 'New Character', pronouns: '', level: 1,
    ancestry: '', community: '', class: '', subclass: '',
    traits: { agility:0, strength:0, finesse:0, instinct:0, presence:0, knowledge:0 },
    evasion: 10, hpMax: 6, hpMarked: 0,
    stressMax: 6, stressMarked: 0,
    armorScore: 0, armorSlots: 0, armorMarked: 0,
    thresholds: { major:0, severe:0 },
    hope: 2, fear: 0,
    weapons: [],
    armor: { name:'' },
    experiences: [],
    domainCards: [],
    notes: ''
  };
}

function loadAll() {
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
  catch { return []; }
}

function saveAll(chars) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(chars));
}

let characters = loadAll();
let currentId = null;

function current() {
  return characters.find(c => c.id === currentId);
}

function save() {
  saveAll(characters);
}

// --- Tier & Proficiency ---
function tierFromLevel(lvl) {
  if (lvl <= 3) return 1;
  if (lvl <= 6) return 2;
  if (lvl <= 9) return 3;
  return 4;
}
function profFromLevel(lvl) {
  return '+' + (Math.floor((lvl - 1) / 2) + 1);
}

function updateDerived() {
  const c = current(); if (!c) return;
  const lvl = c.level || 1;
  document.getElementById('tierDisplay').value = 'Tier ' + tierFromLevel(lvl);
  document.getElementById('profDisplay').value = profFromLevel(lvl);
}

// --- Dropdown population ---
function populateDropdowns() {
  const aSelect = document.getElementById('ancestrySelect');
  const cSelect = document.getElementById('communitySelect');
  const clSelect = document.getElementById('classSelect');
  // Ancestry
  aSelect.innerHTML = '<option value="">-- Select Ancestry --</option>';
  DAGGERHEART_DATA.ancestries.forEach(a => {
    aSelect.innerHTML += `<option value="${a}">${a}</option>`;
  });
  // Community
  cSelect.innerHTML = '<option value="">-- Select Community --</option>';
  DAGGERHEART_DATA.communities.forEach(c => {
    cSelect.innerHTML += `<option value="${c}">${c}</option>`;
  });
  // Class
  clSelect.innerHTML = '<option value="">-- Select Class --</option>';
  Object.keys(DAGGERHEART_DATA.classes).forEach(cl => {
    clSelect.innerHTML += `<option value="${cl}">${cl}</option>`;
  });
}

function updateSubclassOptions(className) {
  const subSelect = document.getElementById('subclassSelect');
  subSelect.innerHTML = '<option value="">-- Select Subclass --</option>';
  if (className && DAGGERHEART_DATA.classes[className]) {
    DAGGERHEART_DATA.classes[className].subclasses.forEach(sc => {
      subSelect.innerHTML += `<option value="${sc}">${sc}</option>`;
    });
  }
}

function onClassChange(className) {
  const c = current(); if (!c) return;
  updateSubclassOptions(className);
  const validSubs = className && DAGGERHEART_DATA.classes[className] ? DAGGERHEART_DATA.classes[className].subclasses : [];
  if (!validSubs.includes(c.subclass)) {
    c.subclass = '';
    document.getElementById('subclassSelect').value = '';
  }
  recalcStats();
  save();
  updateCardBrowser();
}

function onAncestryChange() {
  recalcStats();
  save();
}

function populateArmorSelect() {
  const sel = document.getElementById('armorSelect');
  sel.innerHTML = '<option value="">-- Select Armor --</option>';
  const tierLabels = {0:'',1:'Tier 1',2:'Tier 2',3:'Tier 3',4:'Tier 4'};
  let currentTier = -1;
  DAGGERHEART_DATA.armor.forEach(a => {
    if (a.tier !== currentTier) {
      currentTier = a.tier;
      if (currentTier > 0) {
        const optGroup = document.createElement('optgroup');
        optGroup.label = tierLabels[currentTier];
        sel.appendChild(optGroup);
      }
    }
    const opt = document.createElement('option');
    opt.value = a.name;
    opt.textContent = a.name;
    const parent = currentTier > 0 ? sel.querySelector(`optgroup[label="${tierLabels[currentTier]}"]`) : sel;
    parent.appendChild(opt);
  });
}

function onArmorChange(armorName) {
  const c = current(); if (!c) return;
  c.armor.name = armorName;
  recalcStats();
  save();
}

function recalcStats() {
  const c = current(); if (!c) return;
  const classData = DAGGERHEART_DATA.classes[c.class];
  if (!classData) return;
  const lvl = c.level || 1;

  // Base stats from class
  let hp = classData.hp;
  let stress = 6;
  let evasion = classData.evasion;

  // Ancestry modifiers
  const aMods = DAGGERHEART_DATA.ancestryMods[c.ancestry] || {};
  if (aMods.hp) hp += aMods.hp;
  if (aMods.stress) stress += aMods.stress;
  if (aMods.evasion) evasion += aMods.evasion;

  // Armor
  const armorData = DAGGERHEART_DATA.armor.find(a => a.name === c.armor.name);
  let armorScore = 0, armorSlots = 0, majorTh = lvl, severeTh = lvl * 2, armorFeature = '';
  if (armorData && armorData.name !== 'Unarmored') {
    armorScore = armorData.score;
    armorSlots = armorData.score; // armor slots = armor score
    majorTh = armorData.major + lvl;
    severeTh = armorData.severe + lvl;
    armorFeature = armorData.feature || '';
    if (armorData.evasionMod) evasion += armorData.evasionMod;
  }

  // Apply to character
  c.evasion = evasion;
  c.hpMax = hp;
  c.hpMarked = Math.min(c.hpMarked, c.hpMax);
  c.stressMax = stress;
  c.stressMarked = Math.min(c.stressMarked, c.stressMax);
  c.armorScore = armorScore;
  c.armorSlots = armorSlots;
  c.armorMarked = Math.min(c.armorMarked, c.armorSlots);
  c.thresholds.major = majorTh;
  c.thresholds.severe = severeTh;
  c.hope = Math.max(c.hope, 2);

  // Sync UI
  const evasionEl = document.querySelector('[data-field="evasion"]');
  if (evasionEl) evasionEl.value = c.evasion;
  document.getElementById('hpMaxInput').value = c.hpMax;
  document.getElementById('stressMaxInput').value = c.stressMax;
  document.getElementById('hopeValue').textContent = c.hope;
  // Armor section displays
  document.getElementById('armorScoreDisplay').value = armorScore;
  document.getElementById('armorSlotsDisplay').value = armorSlots;
  document.getElementById('armorMajorDisplay').value = majorTh;
  document.getElementById('armorSevereDisplay').value = severeTh;
  document.getElementById('armorFeatureDisplay').textContent = armorFeature;
  // Combat section displays
  document.getElementById('combatArmorScore').value = armorScore;
  document.getElementById('armorSlotsInput').value = armorSlots;
  document.getElementById('combatThreshMajor').value = majorTh;
  document.getElementById('combatThreshSevere').value = severeTh;
  renderSlots('hpSlots', c.hpMax, c.hpMarked, 'filled-hp', toggleHP);
  renderSlots('stressSlots', c.stressMax, c.stressMarked, 'filled-stress', toggleStress);
  renderSlots('armorSlots', c.armorSlots, c.armorMarked, 'filled-armor', toggleArmor);
}

let browserActiveDomain = 'all';
let browserCollapsed = false;

function toggleCardBrowser() {
  browserCollapsed = !browserCollapsed;
  document.getElementById('cardBrowserBody').style.display = browserCollapsed ? 'none' : '';
  document.getElementById('browserChevron').style.transform = browserCollapsed ? 'rotate(-90deg)' : '';
}

function updateCardBrowser() {
  const c = current(); if (!c) return;
  const group = document.getElementById('cardBrowserGroup');
  const classData = DAGGERHEART_DATA.classes[c.class];
  if (!classData) { group.style.display = 'none'; return; }
  group.style.display = '';
  // Render domain tabs
  const tabsEl = document.getElementById('domainTabs');
  const domains = classData.domains;
  tabsEl.innerHTML = '';
  const allTab = document.createElement('button');
  allTab.className = 'domain-tab' + (browserActiveDomain === 'all' ? ' active' : '');
  allTab.textContent = 'All';
  allTab.onclick = () => { browserActiveDomain = 'all'; renderBrowserCards(); updateDomainTabActive(); };
  tabsEl.appendChild(allTab);
  domains.forEach(d => {
    const tab = document.createElement('button');
    tab.className = 'domain-tab' + (browserActiveDomain === d ? ' active' : '');
    tab.textContent = d;
    tab.onclick = () => { browserActiveDomain = d; renderBrowserCards(); updateDomainTabActive(); };
    tabsEl.appendChild(tab);
  });
  browserActiveDomain = 'all';
  renderBrowserCards();
}

function updateDomainTabActive() {
  document.querySelectorAll('#domainTabs .domain-tab').forEach(t => {
    t.classList.toggle('active', t.textContent === (browserActiveDomain === 'all' ? 'All' : browserActiveDomain));
  });
}

function renderBrowserCards() {
  const c = current(); if (!c) return;
  const listEl = document.getElementById('browserCardList');
  listEl.innerHTML = '';
  const classData = DAGGERHEART_DATA.classes[c.class];
  if (!classData) return;
  const domains = browserActiveDomain === 'all' ? classData.domains : [browserActiveDomain];
  const level = c.level || 1;
  const existingNames = new Set(c.domainCards.map(d => d.name));

  domains.forEach(domain => {
    const cards = DAGGERHEART_DATA.domainCards[domain] || [];
    cards.forEach(card => {
      if (card.level > level) return;
      const added = existingNames.has(card.name);
      const row = document.createElement('div');
      row.className = 'browser-card' + (added ? ' already-added' : '');
      row.innerHTML = `
        <div class="card-info">
          <span class="card-name">${esc(card.name)}</span>
          <span class="card-meta">Lv${card.level} ${card.type} &middot; ${domain}</span>
        </div>
        ${added ? '<span style="color:var(--text-dark);font-size:0.75rem">Added</span>' :
          `<button class="btn btn-sm" onclick="addBrowserCard('${esc(card.name)}','${card.type}','${domain}','loadout')">+Loadout</button>
           <button class="btn btn-sm" onclick="addBrowserCard('${esc(card.name)}','${card.type}','${domain}','vault')">+Vault</button>`}`;
      listEl.appendChild(row);
    });
  });
  if (listEl.children.length === 0) {
    listEl.innerHTML = '<div style="color:var(--text-dark);font-size:0.85rem;padding:0.5rem">No cards available at current level.</div>';
  }
}

function addBrowserCard(name, type, domain, location) {
  const c = current(); if (!c) return;
  c.domainCards.push({ name, description: '', location, type, domain });
  save();
  renderDomainCards();
  renderBrowserCards();
}

// --- Character selector ---
function populateCharSelect() {
  const sel = document.getElementById('charSelect');
  sel.innerHTML = '';
  characters.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.id;
    opt.textContent = c.name || 'Unnamed';
    sel.appendChild(opt);
  });
  if (currentId) sel.value = currentId;
}

function switchCharacter(id) {
  currentId = id;
  loadCharacterUI();
}

function newCharacter() {
  const c = defaultChar();
  characters.push(c);
  currentId = c.id;
  save();
  populateCharSelect();
  loadCharacterUI();
}

function deleteCharacter() {
  if (characters.length <= 1) return;
  if (!confirm('Delete this character?')) return;
  characters = characters.filter(c => c.id !== currentId);
  currentId = characters[0].id;
  save();
  populateCharSelect();
  loadCharacterUI();
}

// --- Slot renderers ---
function renderSlots(containerId, max, marked, fillClass, onToggle) {
  const el = document.getElementById(containerId);
  el.innerHTML = '';
  for (let i = 0; i < max; i++) {
    const slot = document.createElement('div');
    slot.className = 'slot' + (i < marked ? ' ' + fillClass : '');
    slot.onclick = () => onToggle(i);
    el.appendChild(slot);
  }
}

function toggleHP(i) {
  const c = current(); if (!c) return;
  c.hpMarked = (i < c.hpMarked) ? i : i + 1;
  save();
  renderSlots('hpSlots', c.hpMax, c.hpMarked, 'filled-hp', toggleHP);
}

function toggleStress(i) {
  const c = current(); if (!c) return;
  c.stressMarked = (i < c.stressMarked) ? i : i + 1;
  save();
  renderSlots('stressSlots', c.stressMax, c.stressMarked, 'filled-stress', toggleStress);
}

function toggleArmor(i) {
  const c = current(); if (!c) return;
  c.armorMarked = (i < c.armorMarked) ? i : i + 1;
  save();
  renderSlots('armorSlots', c.armorSlots, c.armorMarked, 'filled-armor', toggleArmor);
}

// --- Traits ---
function renderTraits() {
  const c = current(); if (!c) return;
  const grid = document.getElementById('traitsGrid');
  grid.innerHTML = '';
  TRAITS.forEach(t => {
    const val = c.traits[t] || 0;
    const block = document.createElement('div');
    block.className = 'trait-block';
    block.innerHTML = `
      <span class="trait-name">${t}</span>
      <span class="trait-value">${val >= 0 ? '+' + val : val}</span>
      <div class="trait-controls">
        <button onclick="adjustTrait('${t}',-1)">-</button>
        <button onclick="adjustTrait('${t}',1)">+</button>
      </div>`;
    grid.appendChild(block);
  });
}

function adjustTrait(t, delta) {
  const c = current(); if (!c) return;
  c.traits[t] = Math.max(-3, Math.min(3, (c.traits[t] || 0) + delta));
  save();
  renderTraits();
}

// --- Counters ---
function adjustCounter(field, delta) {
  const c = current(); if (!c) return;
  c[field] = Math.max(0, (c[field] || 0) + delta);
  save();
  document.getElementById(field + 'Value').textContent = c[field];
}

// --- Weapons ---
function renderWeapons() {
  const c = current(); if (!c) return;
  const el = document.getElementById('weaponsList');
  el.innerHTML = '';
  c.weapons.forEach((w, i) => {
    const item = document.createElement('div');
    item.className = 'list-item';
    item.innerHTML = `
      <div class="list-fields">
        <div class="row">
          <select onchange="updateWeapon(${i},'slot',this.value)" style="width:100px;flex-shrink:0">
            <option value="primary" ${w.slot==='primary'?'selected':''}>Primary</option>
            <option value="secondary" ${w.slot==='secondary'?'selected':''}>Secondary</option>
            <option value="inventory" ${w.slot==='inventory'?'selected':''}>Inventory</option>
          </select>
          <input type="text" value="${esc(w.name)}" placeholder="Name" oninput="updateWeapon(${i},'name',this.value)">
        </div>
        <input type="text" value="${esc(w.description)}" placeholder="Properties / description" oninput="updateWeapon(${i},'description',this.value)">
      </div>
      <button class="remove-btn" onclick="removeWeapon(${i})">&times;</button>`;
    el.appendChild(item);
  });
}

function addWeapon() {
  const c = current(); if (!c) return;
  c.weapons.push({ name:'', description:'', slot:'primary' });
  save(); renderWeapons();
}
function removeWeapon(i) {
  const c = current(); if (!c) return;
  c.weapons.splice(i, 1);
  save(); renderWeapons();
}
function updateWeapon(i, key, val) {
  const c = current(); if (!c) return;
  c.weapons[i][key] = val;
  save();
}

// --- Experiences ---
function renderExperiences() {
  const c = current(); if (!c) return;
  const el = document.getElementById('experiencesList');
  el.innerHTML = '';
  c.experiences.forEach((e, i) => {
    const item = document.createElement('div');
    item.className = 'list-item';
    item.innerHTML = `
      <div class="list-fields">
        <div class="row">
          <input type="text" value="${esc(e.name)}" placeholder="Experience tag" oninput="updateExperience(${i},'name',this.value)">
          <input type="number" class="small-input" value="${e.value}" min="0" oninput="updateExperience(${i},'value',+this.value)">
        </div>
      </div>
      <button class="remove-btn" onclick="removeExperience(${i})">&times;</button>`;
    el.appendChild(item);
  });
}

function addExperience() {
  const c = current(); if (!c) return;
  c.experiences.push({ name:'', value:2 });
  save(); renderExperiences();
}
function removeExperience(i) {
  const c = current(); if (!c) return;
  c.experiences.splice(i, 1);
  save(); renderExperiences();
}
function updateExperience(i, key, val) {
  const c = current(); if (!c) return;
  c.experiences[i][key] = val;
  save();
}

// --- Domain Cards ---
function renderDomainCards() {
  const c = current(); if (!c) return;
  ['loadout','vault'].forEach(loc => {
    const el = document.getElementById(loc + 'List');
    el.innerHTML = '';
    c.domainCards.forEach((d, i) => {
      if (d.location !== loc) return;
      const other = loc === 'loadout' ? 'vault' : 'loadout';
      const item = document.createElement('div');
      item.className = 'list-item';
      const meta = d.domain ? `<span style="color:var(--text-dark);font-size:0.75rem">${esc(d.domain)}${d.type ? '  '+esc(d.type) : ''}</span>` : '';
      item.innerHTML = `
        <div class="list-fields">
          <input type="text" value="${esc(d.name)}" placeholder="Card name" oninput="updateDomainCard(${i},'name',this.value)">
          ${meta}
          <input type="text" value="${esc(d.description)}" placeholder="Description / effect" oninput="updateDomainCard(${i},'description',this.value)">
          <button class="move-btn" onclick="moveDomainCard(${i},'${other}')">Move to ${other}</button>
        </div>
        <button class="remove-btn" onclick="removeDomainCard(${i})">&times;</button>`;
      el.appendChild(item);
    });
  });
}

function addDomainCard(location) {
  const c = current(); if (!c) return;
  c.domainCards.push({ name:'', description:'', location });
  save(); renderDomainCards();
}
function removeDomainCard(i) {
  const c = current(); if (!c) return;
  c.domainCards.splice(i, 1);
  save(); renderDomainCards(); renderBrowserCards();
}
function updateDomainCard(i, key, val) {
  const c = current(); if (!c) return;
  c.domainCards[i][key] = val;
  save();
}
function moveDomainCard(i, to) {
  const c = current(); if (!c) return;
  c.domainCards[i].location = to;
  save(); renderDomainCards(); renderBrowserCards();
}

// --- Generic field binding ---
function setNestedField(obj, path, val) {
  const parts = path.split('.');
  let cur = obj;
  for (let i = 0; i < parts.length - 1; i++) {
    cur = cur[parts[i]];
  }
  cur[parts[parts.length - 1]] = val;
}

function getNestedField(obj, path) {
  return path.split('.').reduce((o, k) => (o || {})[k], obj);
}

function bindFields() {
  const c = current(); if (!c) return;
  document.querySelectorAll('[data-field]').forEach(el => {
    const field = el.dataset.field;
    const val = getNestedField(c, field);
    el.value = val ?? '';

    const handler = () => {
      const v = el.type === 'number' ? (el.value === '' ? 0 : +el.value) : el.value;
      setNestedField(c, field, v);
      if (field === 'name') {
        populateCharSelect();
        document.getElementById('charSelect').value = currentId;
      }
      if (field === 'level') { updateDerived(); recalcStats(); save(); updateCardBrowser(); }
      if (field === 'class') onClassChange(el.value);
      if (field === 'ancestry') onAncestryChange();
      save();
    };
    if (el.tagName === 'SELECT') {
      el.onchange = handler;
    } else {
      el.oninput = handler;
    }
  });
}

// --- Slot max config ---
function bindSlotConfig() {
  const c = current(); if (!c) return;

  const hpMax = document.getElementById('hpMaxInput');
  hpMax.value = c.hpMax;
  hpMax.oninput = () => {
    c.hpMax = Math.max(1, +hpMax.value || 1);
    c.hpMarked = Math.min(c.hpMarked, c.hpMax);
    save();
    renderSlots('hpSlots', c.hpMax, c.hpMarked, 'filled-hp', toggleHP);
  };

  const stressMax = document.getElementById('stressMaxInput');
  stressMax.value = c.stressMax;
  stressMax.oninput = () => {
    c.stressMax = Math.max(1, +stressMax.value || 1);
    c.stressMarked = Math.min(c.stressMarked, c.stressMax);
    save();
    renderSlots('stressSlots', c.stressMax, c.stressMarked, 'filled-stress', toggleStress);
  };

  const armorMax = document.getElementById('armorSlotsInput');
  armorMax.value = c.armorSlots;
  armorMax.oninput = () => {
    c.armorSlots = Math.max(0, +armorMax.value || 0);
    c.armorMarked = Math.min(c.armorMarked, c.armorSlots);
    save();
    renderSlots('armorSlots', c.armorSlots, c.armorMarked, 'filled-armor', toggleArmor);
  };
}

// --- Section collapse ---
function toggleSection(headerEl) {
  headerEl.closest('.section').classList.toggle('collapsed');
}

// --- Escape HTML ---
function esc(s) {
  const d = document.createElement('div');
  d.textContent = s || '';
  return d.innerHTML;
}

// --- Load full UI for current char ---
function loadCharacterUI() {
  const c = current(); if (!c) return;
  // Ensure armor object exists for older saved characters
  if (!c.armor || typeof c.armor === 'string') c.armor = { name: c.armor || '' };
  if (c.armor.name === undefined) c.armor = { name: '' };
  populateDropdowns();
  populateArmorSelect();
  bindFields();
  // Sync subclass options based on saved class
  updateSubclassOptions(c.class);
  // Re-set dropdown values after options populated
  document.getElementById('ancestrySelect').value = c.ancestry || '';
  document.getElementById('communitySelect').value = c.community || '';
  document.getElementById('classSelect').value = c.class || '';
  document.getElementById('subclassSelect').value = c.subclass || '';
  document.getElementById('armorSelect').value = c.armor.name || '';
  // Wire armor dropdown
  document.getElementById('armorSelect').onchange = function() { onArmorChange(this.value); };
  bindSlotConfig();
  updateDerived();
  // Recalc derived stats if class is set
  if (c.class && DAGGERHEART_DATA.classes[c.class]) {
    recalcStats();
    save();
  } else {
    // Show armor UI even without class
    const armorData = DAGGERHEART_DATA.armor.find(a => a.name === c.armor.name);
    const aScore = c.armorScore || 0;
    const aMaj = c.thresholds.major || 0;
    const aSev = c.thresholds.severe || 0;
    document.getElementById('armorScoreDisplay').value = aScore;
    document.getElementById('armorSlotsDisplay').value = c.armorSlots || 0;
    document.getElementById('armorMajorDisplay').value = aMaj;
    document.getElementById('armorSevereDisplay').value = aSev;
    document.getElementById('armorFeatureDisplay').textContent = armorData ? armorData.feature || '' : '';
    document.getElementById('combatArmorScore').value = aScore;
    document.getElementById('combatThreshMajor').value = aMaj;
    document.getElementById('combatThreshSevere').value = aSev;
  }
  renderTraits();
  renderSlots('hpSlots', c.hpMax, c.hpMarked, 'filled-hp', toggleHP);
  renderSlots('stressSlots', c.stressMax, c.stressMarked, 'filled-stress', toggleStress);
  renderSlots('armorSlots', c.armorSlots, c.armorMarked, 'filled-armor', toggleArmor);
  document.getElementById('hopeValue').textContent = c.hope;
  document.getElementById('fearValue').textContent = c.fear;
  renderWeapons();
  renderExperiences();
  renderDomainCards();
  updateCardBrowser();
}

// --- Init ---
document.getElementById('charSelect').addEventListener('change', function() {
  switchCharacter(this.value);
});

if (characters.length === 0) {
  newCharacter();
} else {
  currentId = characters[0].id;
  populateCharSelect();
  loadCharacterUI();
}
</script>
</body>
</html>
